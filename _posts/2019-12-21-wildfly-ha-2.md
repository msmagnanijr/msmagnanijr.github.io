---
layout: post
title: Building a Mission-Critical Open Source Environment for the Java Platform - Chapter II
tags: [jboss, wildfly, ha, redhat, centos, modcluster]
comments: true
---

In [Chapter I](http://mlab.run/2019/12/18/wildfly-ha-1), we set up the high availability of the Web layer. In this chapter we will install WildFly and connect it to Mod Cluster.

##  Install Wildfly 18

Let's start building the application layer of our environment.These settings will be performed on the following servers:

* server-domain.mmagnani.lab - 10.0.0.68
* server-slave-0.mmagnani.lab -10.0.0.67
* server-slave-1.mmagnani.lab - 10.0.0.66


Let's start with the server that will be the "Master":

{% highlight bash %}
[root@server-domain ~]# cat /etc/redhat-release 
CentOS Linux release 7.7.1908 (Core)
[root@server-domain ~]# systemctl stop firewalld
[root@server-domain ~]# systemctl disable firewalld
[root@server-domain ~]# setenforce 0
[root@server-domain ~]# sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config
[root@server-domain ~]# yum install java-1.8.0-openjdk-devel.x86_64 vim wget unzip telnet -y
[root@server-domain ~]# mkdir -p /usr/local/wildfly
[root@server-domain ~]# wget https://download.jboss.org/wildfly/18.0.1.Final/wildfly-18.0.1.Final.zip -P /usr/local/wildfly
[root@server-domain ~]# cd /usr/local/wildfly
[root@server-domain ~]# unzip wildfly-18.0.1.Final.zip
[root@server-domain ~]# useradd -p `openssl passwd -1 wildfly` wildfly
[root@server-domain ~]# usermod -aG wildfly wildfly
[root@server-domain ~]# chown -R wildfly:wildfly /usr/local/wildfly/wildfly-18.0.1.Final
[root@server-domain ~]# vi /etc/systemd/system/wildfly.service

Description=WildFly 18.0.1
After=syslog.target network.target

[Service]
Type=simple
ExecStart=/usr/local/wildfly/wildfly-18.0.1.Final/bin/domain.sh

[Install]
WantedBy=multi-user.target

[root@server-domain ~]# systemctl enable wildfly
[root@server-domain ~]# reboot
{% endhighlight %}

Check that the WildFly process has gone up correctly:

{% highlight bash %}
[root@server-domain ~]# jps -m
1571 jboss-modules.jar -mp /usr/local/wildfly/wildfly-18.0.1.Final/modules 
#suppress
{% endhighlight %}

Now let's set up "Slave 0":

{% highlight bash %}
[root@server-slave-0 ~]# cat /etc/redhat-release 
CentOS Linux release 7.7.1908 (Core)
[root@server-slave-0 ~]# systemctl stop firewalld
[root@server-slave-0 ~]# systemctl disable firewalld
[root@server-slave-0 ~]# setenforce 0
[root@server-slave-0 ~]# sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config
[root@server-slave-0 ~]# yum install java-1.8.0-openjdk-devel.x86_64 vim wget unzip telnet -y
[root@server-slave-0 ~]# mkdir -p /usr/local/wildfly
[root@server-slave-0 ~]# wget https://download.jboss.org/wildfly/18.0.1.Final/wildfly-18.0.1.Final.zip -P /usr/local/wildfly
[root@server-slave-0 ~]# cd /usr/local/wildfly
[root@server-slave-0 ~]# unzip wildfly-18.0.1.Final.zip
[root@server-slave-0 ~]# useradd -p `openssl passwd -1 wildfly` wildfly
[root@server-slave-0 ~]# usermod -aG wildfly wildfly
[root@server-slave-0 ~]# chown -R wildfly:wildfly /usr/local/wildfly/wildfly-18.0.1.Final
[root@server-slave-0 ~]# vi /etc/systemd/system/wildfly.service

Description=WildFly 18.0.1
After=syslog.target network.target

[Service]
Type=simple
ExecStart=/usr/local/wildfly/wildfly-18.0.1.Final/bin/domain.sh

[Install]
WantedBy=multi-user.target

[root@server-slave-0~]# systemctl enable wildfly
[root@server-slave-0 ~]# reboot
{% endhighlight %}

Check that the WildFly process has gone up correctly:

{% highlight bash %}
[root@server-slave-0 ~]# jps -m
1968 jboss-modules.jar -mp /usr/local/wildfly/wildfly-18.0.1.Final/modules org.jboss.as.server
#suppress
{% endhighlight %}

And now let's set up "Slave 1":

{% highlight bash %}
[root@server-slave-1 ~]# cat /etc/redhat-release 
CentOS Linux release 7.7.1908 (Core)
[root@server-slave-1 ~]# systemctl stop firewalld
[root@server-slave-1 ~]# systemctl disable firewalld
[root@server-slave-1 ~]# setenforce 0
[root@server-slave-1 ~]# sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config
[root@server-slave-1 ~]# yum install java-1.8.0-openjdk-devel.x86_64 vim wget unzip telnet -y
[root@server-slave-1 ~]# mkdir -p /usr/local/wildfly
[root@server-slave-1 ~]# wget https://download.jboss.org/wildfly/18.0.1.Final/wildfly-18.0.1.Final.zip -P /usr/local/wildfly
[root@server-slave-1 ~]# cd /usr/local/wildfly
[root@server-slave-1 ~]# unzip wildfly-18.0.1.Final.zip
[root@server-slave-1 ~]# useradd -p `openssl passwd -1 wildfly` wildfly
[root@server-slave-1 ~]# usermod -aG wildfly wildfly
[root@server-slave-1 ~]# chown -R wildfly:wildfly /usr/local/wildfly/wildfly-18.0.1.Final
[root@server-domain wildfly]# vi /etc/systemd/system/wildfly.service

Description=WildFly 18.0.1
After=syslog.target network.target

[Service]
Type=simple
ExecStart=/usr/local/wildfly/wildfly-18.0.1.Final/bin/domain.sh

[Install]
WantedBy=multi-user.target

[root@server-slave-1 ~]# systemctl enable wildfly
[root@server-slave-1 ~]# reboot
{% endhighlight %}

Check that the WildFly process has gone up correctly:

{% highlight bash %}
[root@server-slave-0 ~]# jps -m
1948 jboss-modules.jar -mp /usr/local/wildfly/wildfly-18.0.1.Final/modules org.jboss.as.server
#suppress
{% endhighlight %}

It is! Finally we have Wildfly running in Domain Mode on all three servers.

## Configuring the Master/Slave Architecture

This part of the setup will need a little more hard work because requires attention to detail but don't worry, let's go step by step.

The first step is to set the variables correctly so WildFly can understand where our settings are and what we want to do with them.

Edit the `domain.conf` file and add the binding settings for the `JAVA_OPTS` variable:

{% highlight bash %}
[root@server-domain ~]# vim /usr/local/wildfly/wildfly-18.0.1.Final/bin/domain.conf

if [ "x$JAVA_OPTS" = "x" ]; then
   JAVA_OPTS="-Xms64m -Xmx512m -XX:MaxMetaspaceSize=256m -Djava.net.preferIPv4Stack=true"
   JAVA_OPTS="$JAVA_OPTS -Djboss.modules.system.pkgs=$JBOSS_MODULES_SYSTEM_PKGS -Djava.awt.headless=true"
   
   #Add this line
   JAVA_OPTS="$JAVA_OPTS -Djboss.bind.address.management=10.0.0.68 -Djboss.bind.address=10.0.0.68"
else
{% endhighlight %}

Open the server URL and note that WildFly is running and accessible: http://10.0.0.68:8080

![](/images/201912-hawildfly-06.png)

The next step is to create/update a management user and a directory for the domain to starting the configuration of WildFly server topology.

{% highlight bash %}
[root@server-domain ~]# cd /usr/local/wildfly/wildfly-18.0.1.Final/bin
[root@server-domain ~]# ./add-user.sh 

What type of user do you wish to add? 
 a) Management User (mgmt-users.properties) 
 b) Application User (application-users.properties)
(a): a

Enter the details of the new user to add.
Using realm 'ManagementRealm' as discovered from the existing property files.
Username : admin
User 'admin' already exists and is disabled, would you like to... 
 a) Update the existing user password and roles 
 b) Enable the existing user 
 c) Type a new username
(a): a
Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
 - The password should be different from the username
 - The password should not be one of the following restricted values {root, admin, administrator}
 - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
Password : Redhat*#2
Re-enter Password : Redhat*#2
What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[  ]: 
Updated user 'admin' to file '/usr/local/wildfly/wildfly-18.0.1.Final/standalone/configuration/mgmt-users.properties'
Updated user 'admin' to file '/usr/local/wildfly/wildfly-18.0.1.Final/domain/configuration/mgmt-users.properties'
Updated user 'admin' with groups  to file '/usr/local/wildfly/wildfly-18.0.1.Final/standalone/configuration/mgmt-groups.properties'
Updated user 'admin' with groups  to file '/usr/local/wildfly/wildfly-18.0.1.Final/domain/configuration/mgmt-groups.properties'
Is this new user going to be used for one AS process to connect to another AS process? 
e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
yes/no? yes
To represent the user add the following to the server-identities definition <secret value="WG9saW4qIzI=" />
{% endhighlight %}

Take note of the <secret value="WG9saW4qIzI=" />, this will be used to configure the Slaves connection.

Now create a new directory called "master" based on the "domain" directory.

{% highlight bash %}
[root@server-domain ~]# pwd
/usr/local/wildfly/wildfly-18.0.1.Final
[root@server-domain ~]# cp -Rap domain master
{% endhighlight %}

Edit again the `domain.conf` file and add the binding settings for the `JAVA_OPTS` variable:

{% highlight bash %}
[root@server-domain ~]# vi /usr/local/wildfly/wildfly-18.0.1.Final/bin/domain.conf

if [ "x$JAVA_OPTS" = "x" ]; then
   JAVA_OPTS="-Xms64m -Xmx512m -XX:MaxMetaspaceSize=256m -Djava.net.preferIPv4Stack=true"
   JAVA_OPTS="$JAVA_OPTS -Djboss.modules.system.pkgs=$JBOSS_MODULES_SYSTEM_PKGS -Djava.awt.headless=true"
   
   #Edit this line
   JAVA_OPTS="$JAVA_OPTS -Djboss.bind.address.management=10.0.0.68 -Djboss.bind.address=10.0.0.68 -Djboss.domain.base.dir=/usr/local/wildfly/wildfly-18.0.1.Final/master"
else
{% endhighlight %}

Restart WildFly and access the management URL by logging in with user "admin" and previously updated password: http://10.0.0.68:9990

{% highlight bash %}
[root@server-domain wildfly-18.0.1.Final]# systemctl restart wildfly
{% endhighlight %}

![](/images/201912-hawildfly-07.png)

In the management console you will notice that we are still using the standard topology but we will work on it in the next steps. 

![](/images/201912-hawildfly-08.png)


#WIP
Best,